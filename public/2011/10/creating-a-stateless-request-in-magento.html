
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Creating a Stateless Request in Magento - TimBroder.com</title>
  <meta name="author" content="Tim Broder">

  
  <meta name="description" content="Have you ever wanted to create a stateless request in Magento? Something that doesn&#8217;t touch any of Matengo&#8217;s sessions?  We were having ...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.timbroder.com/2011/10/creating-a-stateless-request-in-magento.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/timbroder" rel="alternate" title="TimBroder.com" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">TimBroder.com</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/timbroder" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.timbroder.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Creating a Stateless Request in Magento</h1>
    
    
      <p class="meta">
        





  



<time datetime="2011-10-17T18:45:00-04:00" pubdate  data-updated="true" >Oct 17<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Have you ever wanted to create a stateless request in Magento? Something that doesn&#8217;t touch any of Matengo&#8217;s sessions?  We were having issues with some of the ajax calls on our cart and checkout pages mucking with the user&#8217;s cart and had get stateless on these calls.  The issue we were having was out checkout page was loading, then a javascript include was going out and bringing code from a 3rd party relevance engine into our dom, which was in turn calling back an ajax request to our servers.  This issue with this being that at the start of the page load page load, the checkout session was being set to a certain state.  This state was then being sent through the rest of the page load, and the ajax calls. Unfortunately, by the time the ajax call got back to our server, the session was different in both locations, creating a race condition.  The ajax request usually won, removing the work the full page load had done with trying to process checkout.  The good news was there was nothing in the ajax call that needed to touch the session, it was just some data lookup. So, nix the session part of that call, and our troubles should be over&#8230; Magento&#8217;s api controller is the only place that implements a stateless request this but its fairly easy to do (after a bit of digging).</p>

<p>As long as Mage_Core_Controller_Varien_Action is a parent in your controller&#8217;s hierchy, you are good to go (it probably is).  This class has a const FLAG_NO_START_SESSION which looks promising. Digging into the code a little we see that it controls whether cookies are processed or the session is started:</p>

<div><script src='https://gist.github.com/1293475.js?file='></script>
<noscript><pre><code>&lt;?php
...
        if (!$this-&gt;getFlag('', self::FLAG_NO_START_SESSION)) {
            $checkCookie = in_array($this-&gt;getRequest()-&gt;getActionName(), $this-&gt;_cookieCheckActions);
            $checkCookie = $checkCookie &amp;&amp; !$this-&gt;getRequest()-&gt;getParam('nocookie', false);
            $cookies = Mage::getSingleton('core/cookie')-&gt;get();
            if ($checkCookie &amp;&amp; empty($cookies)) {
                $this-&gt;setFlag('', self::FLAG_NO_COOKIES_REDIRECT, true);
            }
            Mage::getSingleton('core/session', array('name' =&gt; $this-&gt;_sessionNamespace))-&gt;start();
        }</code></pre></noscript></div>


<p>By adding to the preDispatch() method of our Action or Controller we can toggle this:</p>

<div><script src='https://gist.github.com/1293491.js?file='></script>
<noscript><pre><code>&lt;?php
class Ai_AjaxCatalog_Controller_Action extends Mage_Core_Controller_Front_Action
{
    public function preDispatch()
    {
        $this-&gt;setFlag('', self::FLAG_NO_START_SESSION, 1); // Do not start standard session
        parent::preDispatch();
        return $this;
    }
}

test</code></pre></noscript></div>


<p>Now, any action in this controller will be stateless and not effect any sessions</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Tim Broder</span></span>

      





  



<time datetime="2011-10-17T18:45:00-04:00" pubdate  data-updated="true" >Oct 17<span>th</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.timbroder.com/2011/10/creating-a-stateless-request-in-magento.html" data-via="" data-counturl="http://www.timbroder.com/2011/10/creating-a-stateless-request-in-magento.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/10/creating-a-stateless-request-in-magento.html">Creating a Stateless Request in Magento</a>
      </li>
    
      <li class="post">
        <a href="/2011/04/jira-tabs-open-all-those-jiras-at-once.html">Jira Tabs: Open all those Jira's at once! </a>
      </li>
    
      <li class="post">
        <a href="/2011/04/google%25e2%2580%2599s-groupon-competitor-goes-live.html">Googles Groupon Competitor Goes Live</a>
      </li>
    
      <li class="post">
        <a href="/2011/04/skynet.html">Skynet Becomes Self Aware Tonight</a>
      </li>
    
      <li class="post">
        <a href="/2011/04/extending-a-magento-controller.html">Extending a Magento Controller</a>
      </li>
    
  </ul>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Tim Broder -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
    (function () {
      var disqus_shortname = 'broderboy';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.timbroder.com/2011/10/creating-a-stateless-request-in-magento.html';
        var disqus_url = 'http://www.timbroder.com/2011/10/creating-a-stateless-request-in-magento.html';
        var disqus_script = 'embed.js'
      

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
